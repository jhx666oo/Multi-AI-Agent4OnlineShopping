# 16｜成本估算：从 MVP 到规模化的资源规划

> 本文档给出系统各组件的成本估算，帮助做预算规划。

---

## 一、成本构成

| 类别 | 组件 | 成本模型 |
|------|------|----------|
| **计算** | Agent 服务、MCP 服务、Gateway | 按实例/vCPU |
| **LLM** | GPT-4o-mini、GPT-4o、Embedding | 按 token |
| **存储** | PostgreSQL、对象存储 | 按 GB |
| **向量检索** | pgvector / Milvus | 按索引规模 |
| **网络** | API 调用、跨区流量 | 按请求/流量 |

---

## 二、MVP 阶段成本（月度）

### 假设

- 日活用户：100-500
- 日 Draft Order：50-200
- 月 Draft Order：1,500-6,000
- SKU 规模：10,000
- 证据文档：1,000 份

### 成本明细

| 项目 | 规格 | 月成本（USD） |
|------|------|---------------|
| **云服务器** | 2x 2vCPU 4GB（Agent + API） | $40-80 |
| **PostgreSQL** | 托管 2vCPU 4GB 100GB | $50-100 |
| **LLM（GPT-4o-mini 为主）** | 1,500-6,000 次 Draft Order | $100-500 |
| **Embedding** | 索引 + 查询 | $10-30 |
| **对象存储** | 10GB | $1-5 |
| **CDN/流量** | 100GB | $10-20 |
| **总计** | | **$210-735** |

### MVP 预算建议

| 档位 | 月预算 | 适用 |
|------|--------|------|
| 精简版 | $300 | 开发测试 |
| 标准版 | $500 | 小规模上线 |
| 充裕版 | $800 | 有余量应对峰值 |

---

## 三、中期阶段成本（月度）

### 假设

- 日活用户：1,000-5,000
- 日 Draft Order：500-2,000
- 月 Draft Order：15,000-60,000
- SKU 规模：100,000
- 证据文档：10,000 份

### 成本明细

| 项目 | 规格 | 月成本（USD） |
|------|------|---------------|
| **云服务器** | 4x 4vCPU 8GB | $200-400 |
| **PostgreSQL** | 托管 4vCPU 16GB 500GB | $200-400 |
| **Redis** | 2GB | $30-50 |
| **LLM** | 15,000-60,000 次 | $1,000-5,000 |
| **Embedding** | | $50-150 |
| **向量数据库（可选）** | Milvus 托管 | $100-300 |
| **对象存储** | 100GB | $10-30 |
| **监控（DataDog/Grafana）** | | $50-200 |
| **总计** | | **$1,640-6,530** |

---

## 四、规模化阶段成本（月度）

### 假设

- 日活用户：10,000-50,000
- 日 Draft Order：5,000-20,000
- 月 Draft Order：150,000-600,000
- SKU 规模：1,000,000
- 证据文档：100,000 份

### 成本明细

| 项目 | 规格 | 月成本（USD） |
|------|------|---------------|
| **Kubernetes 集群** | 10-20 节点 | $2,000-5,000 |
| **PostgreSQL 集群** | 主从 + 读副本 | $1,000-3,000 |
| **Redis 集群** | 8GB+ | $100-300 |
| **Neo4j（可选）** | | $500-2,000 |
| **Kafka（可选）** | | $300-1,000 |
| **LLM** | 150K-600K 次 | $10,000-50,000 |
| **Embedding** | | $500-1,500 |
| **向量数据库** | Milvus/Pinecone | $500-2,000 |
| **对象存储** | 1TB | $50-100 |
| **CDN** | 1TB 流量 | $100-200 |
| **监控 + 日志** | | $500-1,500 |
| **总计** | | **$15,550-66,600** |

---

## 五、成本优化策略

### 5.1 LLM 成本优化（最大头）

| 策略 | 预期节省 | 说明 |
|------|----------|------|
| **分层调用** | 50-70% | 简单任务用 GPT-4o-mini |
| **缓存常见问答** | 10-20% | 相同查询复用结果 |
| **减少重复调用** | 10-15% | 合并相似请求 |
| **Prompt 压缩** | 5-10% | 精简 system prompt |
| **批量调用** | 5-10% | 使用 Batch API（延迟可接受时） |

### 5.2 存储成本优化

| 策略 | 说明 |
|------|------|
| **Evidence 分层存储** | 热数据 PostgreSQL，冷数据 S3 |
| **向量索引压缩** | 使用 PQ/IVF 降低索引大小 |
| **定期清理** | Evidence 过期清理（保留政策） |

### 5.3 计算成本优化

| 策略 | 说明 |
|------|------|
| **自动伸缩** | 根据负载自动增减实例 |
| **预留实例** | 长期使用购买预留实例（省 30-50%） |
| **Spot 实例** | 非关键任务使用 Spot（省 60-80%） |

---

## 六、成本监控

### 6.1 关键指标

| 指标 | 说明 | 告警 |
|------|------|------|
| `cost.llm.daily` | 日 LLM 成本 | > 预算 80% |
| `cost.llm.per_order` | 单订单 LLM 成本 | > $0.20 |
| `cost.storage.monthly` | 月存储成本 | > 预算 90% |
| `cost.compute.monthly` | 月计算成本 | > 预算 90% |

### 6.2 成本归因

```python
# 按用途归因 LLM 成本
def record_llm_cost(task_type: str, model: str, tokens: int, cost: float):
    metrics.record_cost(
        service="llm",
        task=task_type,  # intent / verification / explanation
        model=model,
        tokens=tokens,
        cost=cost,
    )
```

---

## 七、云服务商选择

### 7.1 推荐组合

| 场景 | 推荐 | 理由 |
|------|------|------|
| **全球跨境** | AWS | 区域覆盖广、服务全 |
| **中国出海** | 阿里云国际 + AWS | 中国合规 + 海外覆盖 |
| **成本敏感** | DigitalOcean / Hetzner | 性价比高 |
| **开发测试** | Railway / Render | 快速部署 |

### 7.2 托管服务 vs 自建

| 服务 | 托管推荐 | 自建场景 |
|------|----------|----------|
| PostgreSQL | ✅ 强烈推荐托管 | 规模极大且有 DBA |
| Redis | ✅ 推荐托管 | 简单场景可自建 |
| Kafka | ⚠️ 看规模 | 小规模用 Redpanda |
| Neo4j | ✅ 推荐托管 | 除非有图数据库专家 |
| 向量库 | ⚠️ 看规模 | 小规模 pgvector 够用 |

---

## 八、ROI 分析

### 假设

- 平均订单金额：$50
- 平均毛利率：15%
- AI 转化率提升：10-20%

### 计算

| 阶段 | 月订单 | 新增订单（+15%） | 新增毛利 | AI 成本 | ROI |
|------|--------|------------------|----------|---------|-----|
| MVP | 5,000 | +750 | $5,625 | $500 | **11x** |
| 中期 | 50,000 | +7,500 | $56,250 | $3,000 | **19x** |
| 规模 | 500,000 | +75,000 | $562,500 | $30,000 | **19x** |

**结论**：AI 成本相对于带来的增量收益，ROI 非常可观。

---

## 九、预算模板

```yaml
# budget-template.yaml

monthly_budget:
  compute:
    servers: $200
    database: $100
    cache: $30
  
  llm:
    gpt4o_mini: $300
    gpt4o: $200
    embedding: $30
  
  storage:
    postgresql: $50
    object_storage: $10
  
  monitoring:
    observability: $50
  
  buffer: $100  # 10% 缓冲

total: $1,070
```

